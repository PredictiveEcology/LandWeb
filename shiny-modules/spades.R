#' Shiny module to initialize a \code{SpaDES} simulation
#'
#' Simply a wrapper around \code{\link[SpaDES.core]{simInit}} to be called as a shiny module.
#'
#' @note This is a server-only module with no UI component.
#'
#' @param input    Shiny server input object.
#' @param output   Shiny server output object.
#' @param session  Shiny server session object.
#' @param ...      Additional arguments passed to \code{simInit}.
#'
#' @return A \code{simList} object
#' @seealso \code{\link[SpaDES.core]{simInit}}
#'
#' @author Alex Chubaty
#' @export
#' @importFrom SpaDES.core simInit
#'
spades_simInit <- function(input, output, session, ...) {
  simInit(...)
}

#' Shiny module to run a \code{SpaDES} simulation experiment
#'
#' Simply a wrapper around \code{\link[SpaDES.core]{experiment}} to be called as a shiny module.
#'
#' @note This is a server-only module with no UI component.
#'
#' @param input    Shiny server input object.
#' @param output   Shiny server output object.
#' @param session  Shiny server session object.
#' @param ...      Additional arguments passed to \code{experiment}.
#'
#' @return A \code{simList} object
#' @seealso \code{\link[SpaDES.core]{experiment}}
#'
#' @author Alex Chubaty
#' @export
#' @importFrom raster endCluster
#' @importFrom reproducible Cache Copy
#' @importFrom SpaDES.core experiment
#'
spades_expt <- function(input, output, session, sim, debugCache = "complete",
                        objectsToHash, reps, seed) {
  # Run Experiment
  set.seed(seed)
  message("Current seed is: ", seed)

  runExperiment <- function(sim, nReps, seed, cacheDebug = "complete", objectsToHash = "") {
    # # Do an initial run for each given study area so that all the data prep can be done once only
    #initialRun1 <- spades(Copy(sim), debug = TRUE)
    # 5 minutes for 6e3 km2
    # 30 minutes for 6e4 km2
    simCopy <- Copy(sim)
    end(simCopy) <- 0
    message("Running Initial spades call")
    initialRun <- Cache(spades, sim = simCopy, #notOlderThan = Sys.time(),
                        debug = "paste(Sys.time(), paste(unname(current(sim)), collapse = ' '))",
                        objects = "shpStudyRegion",
                        #cacheRepo = cachePath(sim),
                        .plotInitialTime = NA,
                        omitArgs = c("debug", ".plotInitialTime"),
                        debugCache = cacheDebug)

    raster::endCluster()
    set.seed(seed)
    message("Current experiment seed is: ", seed)
    args <- list(experiment, sim, replicates = nReps,
                 objects = objectsToHash,
                 debug = "paste(unname(current(sim)), collapse = ' ')",
                 .plotInitialTime = NA,
                 clearSimEnv = TRUE,
                 debugCache = cacheDebug,
                 omitArgs = c("debug", ".plotInitialTime"))
    args <- args[!unlist(lapply(args, is.null))]
    simOut <- do.call(Cache, args)
    message(attr(simOut, "tags"))
    simOut
  }

  # THIS IS THE MAIN "SIMULATION FUNCTION"
  # THE FOLLOWING OBJECT IS A LIST OF 1 simList,
  # A simList is a rich data structure that comes with the SpaDES.core package
  message("  Starting Experiment...")
  mySimOut <- Cache(runExperiment, sim, nReps = reps, seed = seed,
                    cacheDebug = debugCache, debugCache = debugCache,
                    objectsToHash = objectsToHash, objects = objectsToHash)#, sideEffect = TRUE)
  message("  Finished Experiment")

  mySimOut
}
