---
title: "Boreal_LBMRDataPrep"
author: "Yong Luo & Eliot McIntire"
date: "6 October 2017"
output: pdf_document
---

# Overview

This module converts open datasets that are available for all of Canada's forests, into the input requirements for Landis Biomass Succession in R (LBMR). 
This has been partially tested for some parts of the Western Boreal Forest. 

Specifically, it takes the Eco* maps (Ecozone, Ecoprovince, Ecoregion) maps of Canada, and species specific biomass maps of Canada (from Beaudoin et al. 2014).

Keeping these data preparations outside of the core LBMR module maintains the modularity of LBMR.

# Usage

There is one
```{r module_usage}
devtools::install_github("PredictiveEcology/reproducible@development") # require bugfix for one step
devtools::install_github("PredictiveEcology/SpaDES.tools@prepInputs") # prepInputs with alsoExtract argument
devtools::install_github("ygc2l/webDatabases") # For fetching KNN layers from PFC repo

library(magrittr) # for %>% pipe
library(SpaDES)
library(raster)
cachePath <- file.path("Boreal_LBMRDataPrep", "cache")
modulePath <- Cache(readline, paste0("Where is the module path? (e.g., ~/module, with no quotes).\n",
                                     "Press Enter to accept the path in getPaths()$modulePath: "),
                    cacheRepo = cachePath)
if(nchar(modulePath)==0) modulePath <- getPaths()$modulePath
canadaMap <- Cache(getData, 'GADM', country = 'CAN', level = 1,
                   cacheRepo = cachePath, digestPathContent = FALSE) 
dev()
clearPlot()
Plot(canadaMap, speedup = 5, visualSqueeze = 0.9) # 5 seemed optimal
if(!exists("shpStudyRegionFull")) {
  message("Since there is no object called 'shpStudyRegionFull', please draw a study area with 10 points")
  severalrandompoints <- Cache(clickCoordinates, 10, cacheRepo = cachePath)
  if(startsWith(attr(severalrandompoints, "tags"), "cache")) message("Taking shpStudyRegionFull from Cache")
  shpStudyRegionFull <- SpatialPolygons(list(Polygons(list(Polygon(severalrandompoints$coords)), ID = 1)),
                               proj4string = crs(canadaMap))
}
Plot(shpStudyRegionFull, addTo = "canadaMap", col = "red")
inputDir <- file.path(tempdir(), "inputs") %>% checkPath(create = TRUE)
outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 0, end = 10)
modules <- list("Boreal_LBMRDataPrep")
objects <- list("shpStudyRegionFull" = shpStudyRegionFull,
                "shpStudySubRegion" = shpStudyRegionFull)
paths <- list(
  cachePath = cachePath,
  modulePath = modulePath,
  inputPath = inputDir,
  outputPath = outputDir
)

parameters <- list(LBMR = list(successionTimestep = 2, useCache = TRUE))

Cache(downloadData, "Boreal_LBMRDataPrep", path = "..")

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects, paths = paths)

simOut <- spades(mySim)




```

# Downloads

There are 3 `.tar` files (~2GB each) and 1 `.zip` file (~45MB) downloaded from the internet.

# Inputs

This module has several input requirements. 
One is a study area, which should be provided as a SpatialPolygonsDataFrame, and named `shpStudyRegionFull`. This should be inside the boundaries of the boreal forest of Canada. 
When first running the code in this `.Rmd` file, you will be prompted to draw a polygon if none is provided as an input.

## Creates Inputs

Most of the inputs will be created automatically, if they are not provided by the user. 
The automatic creation will work in the boreal forest of Canada.
These are zip files and tar files that are available from various Natural Resources Canada web pages. 
Also, this module gets its Species Traits table from `github.com/dcyr/LANDIS-II_IA_generalUseFiles`.

# Outputs

This will show the outputs of this module, which can be used directly as the inputs for LBMR
```{r}
# List all objects
ls(simOut)

# Examine a few tables a visuals
simOut$speciesTable
Plot(simOut$biomassMap)
simOut$shpStudyRegionFull <- spTransform(simOut$shpStudyRegionFull, crs(simOut$biomassMap))
Plot(simOut$shpStudyRegionFull, addTo = "simOut$biomassMap")
```
