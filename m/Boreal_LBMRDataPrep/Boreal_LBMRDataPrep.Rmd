---
title: "Boreal_LBMRDataPrep"
author: "Yong Luo & Eliot McIntire"
date: "6 October 2017"
output: pdf_document
---

# Overview

This module converts open datasets that are available for all of Canada's forests, into the input requirements for Landis Biomass Succession in R (LBMR). 
This has been partially tested for some parts of the Western Boreal Forest. 

Specifically, it takes the Eco* maps (Ecozone, Ecoprovince, Ecoregion) maps of Canada, and species specific biomass maps of Canada (from Beaudoin et al. 2014).

Keeping these data preparations outside of the core LBMR module maintains the modularity of LBMR.

# Usage

There is one
```{r module_usage}
library(magrittr) # for %>% pipe
library(SpaDES)
library(raster)
cachePath <- file.path("Boreal_LBMRDataPrep", "cache")
modulePath <- Cache(readline, paste0("Where is the module path? (e.g., ~/module, with no quotes).\n",
                                     "Press Enter to accept the path in getPaths()$modulePath: "),
                    cacheRepo = cachePath)
if(nchar(modulePath)==0) modulePath <- getPaths()$modulePath
canadaMap <- Cache(getData, 'GADM', country = 'CAN', level = 1,
                   cacheRepo = cachePath, digestPathContent = FALSE) 
dev()
clearPlot()
Plot(canadaMap, speedup = 5, visualSqueeze = 0.9) # 5 seemed optimal
if(!exists("studyArea")) {
  message("Since there is no object called 'studyArea', please draw a study area with 10 points")
  severalrandompoints <- Cache(clickCoordinates, 10, cacheRepo = cachePath)
  if(startsWith(attr(severalrandompoints, "tags"), "cache")) message("Taking studyArea from Cache")
  studyArea <- SpatialPolygons(list(Polygons(list(Polygon(severalrandompoints$coords)), ID = 1)),
                               proj4string = crs(canadaMap))
}
Plot(studyArea, addTo = "canadaMap", col = "red")
inputDir <- file.path(tempdir(), "inputs") %>% checkPath(create = TRUE)
outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 0, end = 10)
parameters <- list()
modules <- list("Boreal_LBMRDataPrep")
objects <- list("shpStudyRegionFull" = studyArea,
                "useCache" = TRUE,
                "successionTimestep" = 2)
paths <- list(
  cachePath = cachePath,
  modulePath = modulePath,
  inputPath = inputDir,
  outputPath = outputDir
)
mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects, paths = paths)

simOut <- spades(mySim)




```


# Outputs

This will show the outputs of this module, which are the inputs for LBMR
```{r}
# List all objects
ls(simOut)

# Examine a few tables a visuals
simOut$speciesTable
Plot(simOut$biomassMap)
simOut$shpStudyRegionFull <- spTransform(simOut$shpStudyRegionFull, crs(simOut$biomassMap))
Plot(simOut$shpStudyRegionFull, addTo = "simOut$biomassMap")


```
